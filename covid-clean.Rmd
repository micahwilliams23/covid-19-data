---
title: "Visualizing COVID-19"
author: "Micah Williams"
date: "4/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)


# import required packages
library(tidyverse)
library(janitor)
library(gganimate)
library(transformr)

# requires census API key
library(tidycensus)
```

```{r import_data, message=FALSE, warning=FALSE}

# import data from NYTimes csv
corona <- read_csv('us-counties.csv', col_types = c('Dcccii')) %>%
  
  # fix fips for New York City
  mutate(fips = if_else(county == 'New York City', "36061", fips)) %>% 
  
  # add new infection rate column, map_if to prevent error on most recent date
  group_by(fips) %>%
  arrange(date) %>%
  mutate(daily_infect_rate = map_if(date, 
                              ~length(cases[date == .+1]) == 1, 
                              ~(cases[date == .+1] - cases[date == .]) / cases[date == .], 
                              .else = NA_real_),
         
         # extract state code from fips with regex (pattern is first two digits)
         state_code = map_chr(fips, ~str_extract(., '\\d{2}'))) %>%
  unnest(daily_infect_rate)

# import census shapefiles for county geometry
census <- rgdal::readOGR(dsn = './gz_2010_us_050_00_5m','gz_2010_us_050_00_5m')

# convert spatial polygons to latitude/longitude
census.points <- fortify(census, region = 'GEO_ID')

# join census data with coronavirus data
census@data <- census@data %>%
  mutate(fips = paste(STATE,COUNTY,sep=''))%>%
  full_join(corona, by = c('fips', 'NAME' = 'county')) %>%
  clean_names()

# combine joined data with converted county polygons for cases and shapes
covid <- census.points %>%
  full_join(census@data, by = c('id' = 'geo_id')) %>%
  mutate(cases = if_else(cases %in% c(0, NA), NA_integer_, cases))
  
# import spatial polygons for US states
states <- geojsonio::geojson_read(x = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json", 
                 what = "sp")

# repair geometry... intersecting points
# (code from https://stackoverflow.com/questions/46003060/error-using-region-argument-when-fortifying-shapefile)
states <- rgeos::gBuffer(states, byid = T, width = 0)

# convert spatial polygons to latitude/longitude for plotting
state_lines <- fortify(states, region = 'id') %>%
  select(state = id, everything())

# save county lines for choropleths
county_lines <- census@data %>%
  select(c(geo_id:county,fips)) %>%
  full_join(census.points,  by = c('geo_id' = 'id')) %>%
  filter(!is.na(long), !is.na(lat))

# pull state fips from census data
state_fips_df <- census@data %>% 
  select(c(state, state_2)) %>% 
  unique() %>% 
  filter(!is.na(state), !is.na(state_2)) %>% 
  arrange(state)

# transpose matrix from columns of states and codes to rows of states and codes
state_fips <- state_fips_df %>%
  select(code = state) %>%
  mutate(code = as.character(code)) %>%
  t() %>%
  data.frame()

# set column names to cleaned state names ex: Texas -> texas, New Hampshire -> new_hampshire
colnames(state_fips) <- make_clean_names(state_fips_df$state_2)

# define function to get fips code from state name
get_state_fips <- function(state){
  state_fips[state] %>% pull() %>% as.character()
}

# remove variables from environment- this data has already been transformed and is not required for functions
rm(census, census.points, states, state_fips_df)
```

```{r plot_states}

# function takes fips code(s) of states and plots the result as a choropleth
# title arg adds name of region to plot title
# setdates selects date to plot... defaults to previous day for more recent data (hopefully)
# outlines takes tbl of polygon boundaries to plot; defaults to counties

plot_state_cases <- function(fips_codes, fill.var = "cases", title = '', setdate = Sys.Date() - 1){
  
  # filter data for specified fips codes and date
  x.data <- covid %>% 
    filter(state_code %in% fips_codes, date == setdate)

  # filter outlines for relevant outlines
  x.outline <- county_lines %>% 
    filter(state %in% fips_codes) %>%
    select(fips:group)
  
  # specify mapping for plot
  ggplot(mapping = aes(long, lat, group = group)) +
    
    # set color and plot outlines from outlines data
    geom_path(color = '#bbbbbb',
              data = x.outline) +
    
    # plot counties, filled by cases from cases data
    geom_polygon(aes(fill = cases),
                 data = x.data) +
    
    # set scale: low is violet, high is red. set long scale with trans
    scale_fill_gradient(low = '#ddbbff', high = '#e01a1a', 
                        trans = 'log10', na.value = '#bbbbbb') +
    
    # add labels with generated date in subtitle, region name from title arg
    labs(title = paste(title,'Total Confirmed Coronavirus Cases by County'),
         subtitle = paste('Data from', format(as.Date(setdate), '%B %d, %Y')),
         caption = 'Source: New York Times\nCreated by Micah Williams',
         fill = 'Cases', fips = 'County') +
    
    # customize plot with theme (remove background, visually simple)
    theme_minimal() +
    
    # equalize coordinate system for no map distortion
    coord_equal() +
    
    # remove grid lines
    theme(panel.grid = element_blank())
}
```

```{r example_state_plot}
plot_state_cases("06", title = "California", setdate = '2020-04-06')
```

```{r anim_state_cases}
anim_state_cases <- function(fips_codes, title = ''){
  
  # filter covid date for specified states
  x.data <- covid %>% filter(state %in% fips_codes, !is.na(date))

  # filter county lines for specified states
  x.outline <- county_lines %>% filter(state %in% fips_codes)
  
  # set mapping, save gganim object
  new_animation <- ggplot(mapping = aes(long, lat, group = group)) +
    
    # draw outlines from outlines data
    geom_path(color = '#bbbbbb',
              data = x.outline) +
    
    # draw polygons, fill by number of cases
    geom_polygon(aes(fill = cases),
                 data = x.data) +
    
    # set fill scale to same as static graphs, logarithmic
    scale_fill_gradient(low = '#ddbbff', high = '#e01a1a', 
                        trans = 'log10', na.value = '#bbbbbb') +
    
    # add labels, title to plot
    labs(title = paste(title,'Total Confirmed Coronavirus Cases by County'),
         
         # variable from transition: shows date of frame
         subtitle = 'Date: {frame_time}',
         caption = 'Source: New York Times \n Created by Micah Williams',
         fill = 'Cases', fips = 'County') +
    
    # add theme, equalize coordinates, remove grid lines
    theme_void() +
    coord_equal() +
    theme(panel.grid = element_blank()) +
    
    # add transition from gganimate
    transition_time(x.data$date)
  
  # animate object with 20 frame pause at end
  animate(new_animation, end_pause = 20, width = 8, height = 5, units = 'in', res = 144)
}
```

```{r example_anim}
# animation takes time to render, commented out for ease of knitting
# anim_state_cases("15", "Hawaii")
```

```{r top_ten}
top_ten <- corona %>% filter(fips %in%  top_ten_fips, date >= '2020-03-07')

top_ten_order <- top_ten %>% filter(date =='2020-04-07') %>% arrange(desc(cases)) %>% pull(county)

top_ten$county <- factor(top_ten$county, top_ten_order, ordered = T)

line_plot <- top_ten %>% 
  ggplot(aes(date, cases, color = county)) +
  geom_line(size = 1.2) +
  labs(y = 'Total Confirmed Cases (thousands)', x = 'Date',
       title = 'Confirmed Cases of Coronavirus, Top 10 Counties in US',
       subtitle = 'Date: {frame_along}', color = 'County',
       caption = 'Source: New York Times \n Created by Micah Williams') +
  scale_color_brewer(type = 'qual', palette = 'Paired') +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0,80000,20000), 
                     labels = seq(0,80,20)) +
    theme(legend.position = c(0.15, 0.55),
          legend.background = element_rect(fill = '#ffffff90', color = '#ffffffa0')) +
  transition_reveal(date)

line_anim <- animate(line_plot, end_pause = 20, width = 7, height = 5, units = 'in', res = 144)
```

```{r infection_rate}
three_day <- corona %>% filter(date >= '2020-04-03', cases > 8) %>%
  group_by(fips) %>%
  mutate(avg_new_infect_3day = mean(daily_infect_rate)) %>%
  filter(date == '2020-04-06', avg_new_infect_3day >= 0) %>%
  ungroup() %>% 
  mutate(sig_score = avg_new_infect_3day*(log10(cases)),
         sig_normalized = percent_rank(sig_score)) 

three_day %>%
  ggplot(aes(cases, avg_new_infect_3day)) +
  geom_point(color = if_else(three_day$sig_normalized > 0.97, '#d01a1a', '#000000'),
             alpha = if_else(three_day$sig_normalized > 0.97, 1, 0.3)) +
  scale_x_log10(breaks = 1*10^c(1:4),
                labels = c('10','100','1,000','10,000')) +
  labs(x = ' Total Cases', y = 'Daily New Infection Rate',
       title = 'Confirmed Cases vs. Average Daily Infection Rate',
       subtitle = 'Infection rate calculated as average daily rate of change in infections from April 3-6',
       caption = 'Source: New York Times\n Created by Micah Williams') +
  theme_minimal()

ggsave('plots/avg_change.png', width = 7, height = 5)

# show states with most outlier counties
three_day %>% 
  filter(date == '2020-04-06',
         sig_normalized > 0.97) %>%
  select(-c(date, daily_infect_rate, state_code)) %>%
  arrange(desc(sig_normalized)) %>%
  group_by(state) %>%
  count() %>%
  arrange(desc(n))
```
