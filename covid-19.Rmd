---
title: "US Coronavirus Cases"
author: "Micah Williams"
date: "3/29/2020"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(maptools)
library(janitor)
library(gganimate)
library(transformr)
library(geojsonio)
```

```{r import_data, message=FALSE, warning=FALSE}
today = Sys.Date()

date_num <- function(date){
  str_replace_all(as.character(date), '-', '')
}

w_filename <- function(name, path = 'plots/', filetype = 'png'){
  paste(path, date_num(Sys.Date()), '_', name, '.', filetype, sep = '')
}

find_limits <- function(tbl){
  tbl %>% 
  summarize(range_long = list(range(long)), 
            range_lat = list(range(lat))) %>% 
  mutate(
    sugg_long = list(c(
      round(range_long[[1]][1]) - 1.5,
      round(range_long[[1]][2]) + 1.5)),
    
    sugg_lat = list(c(
      round(range_lat[[1]][1]) - 1.5,
      round(range_lat[[1]][2]) + 1.5)),
    ) %>%
  transpose() %>% .[[1]]
} 

census <- rgdal::readOGR(dsn = './gz_2010_us_050_00_5m','gz_2010_us_050_00_5m')
corona <- read_csv('us-counties.csv', col_types = c('Dcccii'))

census.points <- fortify(census, region = 'GEO_ID') %>% 
  mutate(id = group) %>%
  select(-group) 

census@data <- census@data %>%
  mutate(fips = paste(STATE,COUNTY,sep=''))%>%
  full_join(corona, by = c('fips', 'NAME' = 'county')) %>%
  clean_names()

covid <- census.points %>%
  full_join(census@data, by = c('id' = 'geo_id')) %>%
  mutate(cases = if_else(cases %in% c(0, NA), NA_integer_, cases))
  
states <- geojson_read(x = "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json", 
                 what = "sp")

# repair geometry... intersecting points
# (code from https://stackoverflow.com/questions/46003060/error-using-region-argument-when-fortifying-shapefile)
states <- rgeos::gBuffer(states, byid = T, width = 0)

state_lines <- fortify(states, region = 'id')

county_lines <- census@data %>%
  select(c(geo_id:county,fips)) %>%
  full_join(census.points,  by = c('geo_id' = 'id')) %>%
  filter(!is.na(long), !is.na(lat))

rm(census, census.points, corona, states)
```

```{r}
all_fips <- covid %>% pull(state) %>% unique()
outside_fips <- c('15', '02','03','07','14','43','52', '72')
mainland_fips <- all_fips[!all_fips %in% outside_fips & !is.na(all_fips)]

mainland_fips
```


```{r fig.height = 9, fig.width = 12}
plot_states <- function(fips_codes){
  join_by_cols <-  c("long", "lat", "order", "hole", "piece", "id" = "geo_id", "state", "county", "fips")
  
  x <- covid %>%
    filter(state %in% fips_codes,
           date == max(date, na.rm = T)) %>%
    full_join(county_lines[county_lines$state %in% fips_codes,],
              by = join_by_cols)
  
  ggplot(x, aes(long, lat, group = group)) +
    geom_polygon(aes(fill = cases)) +
    geom_path(color = '#aaaaaa', alpha = 0.3) +
    scale_fill_gradient(low = '#ddbbff', high = '#e01a1a', 
                        trans = 'log10', na.value = '#eeeeee') +
    labs(title = 'Total Confirmed Coronavirus Cases by County',
         subtitle = paste('Data from', format(x$date,'%B %d, %Y')),
         caption = 'Source: New York Times \n Data for some counties missing.',
         fill = 'Cases', fips = 'County') +
    theme_void() +
    theme(plot.margin = unit(rep(0.5,4), 'cm'))
}

plot_states(mainland_fips)
ggsave(filename = 'plots/20200403_us.png', width =  12, height = 9)
```

```{r hawaii}
hi <- covid %>%
  filter(state %in% c('15'), !is.na(date))

hi_map_anim <- ggplot(hi %>% filter(date == max(date)), 
                      aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  scale_fill_gradient(low = '#ffeeee', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  # scale_y_continuous(limits = c(34.9, 36.7)) +
  # scale_x_continuous(limits = c(-90.5, -81.5)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County in Hawaii',
       subtitle = paste('Data from', max(hi$date)),
       caption = 'Source: New York Times',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal() +
  theme(legend.position = c(0.2, 0.4),
        legend.box.background = element_rect(fill = '#ffffff', color = '#aaaaaa'))

# animate(hi_map_anim, end_pause = 20, width = 7, height = 5, units = 'in', res = 72)

# ggsave(filename = 'plots/20200403_hi.png', width = 7, height = 5)
```



```{r tennesee}

tn <- covid %>%
  filter(state %in% c('47'))

tn_map_anim <- ggplot(tn, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  scale_fill_gradient(low = '#ffeeee', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  scale_y_continuous(limits = c(34.9, 36.7)) +
  scale_x_continuous(limits = c(-90.5, -81.5)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County in Tennessee',
       subtitle = paste('Data from April 3, 2020'),
       caption = 'Source: New York Times \n Data for some counties missing.',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal()

# animate(tn_map_anim, end_pause = 20, width = 7, height = 5, units = 'in', res = 72)

ggsave(filename = 'plots/20200403_tn.png', width = 7, height = 5)

```

```{r}
tx <- covid %>%
  filter(state %in% c('48'))

tx_map_anim <- ggplot(tx_all_counties, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  scale_fill_gradient(low = '#ffeeee', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  # scale_y_continuous(limits = c(34.9, 36.7)) +
  # scale_x_continuous(limits = c(-90.5, -81.5)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County in Texas',
       subtitle = 'Date: {closest_state}',
       caption = 'Source: New York Times \n Data for some counties missing.',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal() #+
  transition_states(states = date)

# animate(tx_map_anim, end_pause = 20, width = 7, height = 5, units = 'in', res = 72)  

# anim_save(filename = 'plots/tx_anim.gif', fig.height = 5, fig.width = 7)
```

```{r}
tx_geom <- tx %>%
  filter(date == today) %>%
  .[,c(1:7, 12:17)] %>%
  unique()

dates <- tx %>% filter(!is.na(date)) %>% pull(date) %>% unique()
# all_tx_counties <- 
  
tx_all_counties <- tibble(date = dates,
  date_rep = map(dates, ~tx_geom)) %>%
  unnest(date_rep) %>%
  full_join(tx, by = c(names(tx_geom), 'date'))

glimpse(tx_all_counties)
```

```{r, fig.height=5, fig.width = 7}
ca <- census@data %>% 
  filter(!is.na(date)) %>%
  full_join(census.points, by = c('geo_id' = 'id')) %>%
  filter(state == '06')


cali_geom <- states.points %>% filter(id == '06')
  
ca_map_anim <- ggplot(ca, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  geom_path(data = cali_geom, aes(long, lat, group = group, fill = NULL)) +
  scale_fill_gradient(low = '#eeeeff', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  labs(title = 'Total Confirmed Coronavirus Cases by County in California',
       subtitle = 'Date: {frame_time}',
       caption = 'Source: New York Times',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal() +
  transition_time(date)

animate(ca_map_anim, end_pause = 20, width = 7, height = 5, units = 'in', res = 144)

ggsave(filename = 'plots/april03_ca.png', width = 7, height = 5, units = 'in', res = 288)
anim_save(filename = 'plots/20200404_ca.gif', animation = ca_map_anim,
          width = 7, height = 5, units = 'in', res = 288, end_pause = 10)

```

```{r}
corona %>% 
  filter(fips %in% c('06037', '53033', '15003')) %>% 
  ggplot(aes(date, cases, color = fips)) + 
  geom_line(size = 1.1) +
  geom_point() +
  scale_color_discrete(name = 'County',
                       labels = c('Los Angeles County',
                                  'Honolulu County',
                                  'King County (Seattle)')) +
  labs(title = 'Confirmed Coronavirus Cases',
       subtitle = 'Data as of April 3',
       caption = 'Source: New York Times') +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  transition_reveal(along = date)

anim_save(filename = 'plots/20200403_counties.gif', fig.height = 5, fig.width = 7, end_pause = 10)
```

```{r}
corona %>% 
  filter(fips %in% c('06037', '53033', '15003', '47037')) %>% 
  ggplot(aes(date, cases, color = fips)) + 
  geom_line(size = 1.1) +
  scale_color_discrete(name = 'County',
                       breaks = c('06037', '53033', '15003', '47037'),
                       labels = c('Los Angeles County',
                                  'King County (Seattle)',
                                  'Honolulu County',
                                  'Davidson County (Nashville)')) +
  labs(title = 'Confirmed Coronavirus Cases',
       subtitle = 'Data as of April 3',
       caption = 'Source: New York Times') +
  theme_minimal() +
  theme(legend.position = c(0.2,0.5))

ggsave(filename = 'plots/20200403_counties.png', height = 5, width = 7)
```

