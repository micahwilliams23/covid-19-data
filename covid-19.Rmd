---
title: "US Coronavirus Cases"
author: "Micah Williams"
date: "3/29/2020"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gt)
library(maptools)
library(raster)
library(sf)
library(janitor)
library(rgdal)
library(rgeos)
library(gganimate)
library(transformr)

library(tidycensus)
```


```{r import}
census <- readOGR(dsn = './gz_2010_us_050_00_5m','gz_2010_us_050_00_5m')
corona <- read_csv('us-counties.csv')

census.points = fortify(census, region = 'GEO_ID')

census@data <- census@data %>%
  mutate(fips = paste(STATE,COUNTY,sep='')) %>%
  full_join(corona, by = c('fips', 'NAME' = 'county')) %>%
  clean_names()
```

```{r}
# if (!require(gpclib)) install.packages("gpclib", type="source")
# gpclibPermit()



 covid <- census.points %>%
  full_join(census@data, by = c('id' = 'geo_id'))

```

```{r}
mainland <- census@data %>%
  full_join(census.points, by = c('geo_id' = 'id')) %>%
  filter(!state %in% c('15', '02','03','07','14','43','52'), date >= '2020-04-01')

get_cases <- function(tbl = hawaii, cur_day){
  tbl %>%
    group_by(county) %>%
    filter(date == cur_day) %>%
    .[c('id','cases','date')] %>%
    unique() %>%
    summarize(total_cases = sum(cases)) %>%
    pull(total_cases)
}

usa <- covid %>%
  filter(!is.na(id),
         !state %in% c('03','07','14','43','52'))

ggplot(mainland, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.03) +
  scale_fill_gradient(low = '#ddffbb', high = rgb(1, 0.2, 0.2), 
                      na.value = '#dddddd', trans = 'log10') +
  scale_y_continuous(limits = c(25, 50)) +
  scale_x_continuous(limits = c(-125, -67)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County',
       subtitle = paste('Data from April 3, 2020'),
       caption = 'Source: New York Times \n Data for some counties missing.',
       fill = 'Cases', fips = 'County') +
  theme_minimal()# +
  # transition_states(states = day)

ggsave(filename = 'plots/april03_us.png', width =  7, height = 5)

# anim_save(filename = 'hawaii_covid.gif',
#           width = 7, height = 5)
```

```{r hawaii}
hi <- census@data %>% 
  filter(date == '2020-04-03') %>%
  full_join(census.points, by = c('geo_id' = 'id')) %>%
  filter(state %in% c('15'))

ggplot(hi, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  scale_fill_gradient(low = '#ffeeee', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  # scale_y_continuous(limits = c(34.9, 36.7)) +
  # scale_x_continuous(limits = c(-90.5, -81.5)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County in Hawaii',
       subtitle = paste('Data from April 3, 2020'),
       caption = 'Source: New York Times',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal() +
  theme(legend.position = c(0.2, 0.4),
        legend.box.background = element_rect(fill = '#ffffff', color = '#aaaaaa'))

ggsave(filename = 'plots/april03_hi.png', width = 7, height = 5)
```



```{r tennesee}
# tn_pop <- get_acs(geography = 'tract', year = 2018, state = '47',
#                   variables = 'B01003_001', geometry = TRUE)

tn <- census@data %>% 
  filter(date == '2020-04-03') %>%
  full_join(census.points, by = c('geo_id' = 'id')) %>%
  filter(state %in% c('47'))

ggplot(tn, aes(long, lat, group = group, fill = cases)) +
  geom_polygon() +
  geom_path(alpha = 0.3) +
  scale_fill_gradient(low = '#ffeeee', high = '#f00000', 
                      na.value = '#dddddd', trans = 'log10') +
  scale_y_continuous(limits = c(34.9, 36.7)) +
  scale_x_continuous(limits = c(-90.5, -81.5)) +
  labs(title = 'Total Confirmed Coronavirus Cases by County in Tennessee',
       subtitle = paste('Data from April 3, 2020'),
       caption = 'Source: New York Times \n Data for some counties missing.',
       x = 'longitude', y = 'latitude',
       fill = 'Cases', fips = 'County') +
  coord_equal() +
  theme_minimal()

ggsave(filename = 'plots/april03_tn.png', width = 7, height = 5)


tn[,c(2:5, 7:8, 10)] %>% 
  unique() %>% 
  filter(is.na(state), str_detect(name, 'City', negate = T))
```


